# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Miryoku KMonad is the Miryoku ergonomic keyboard layout implementation for KMonad. It generates KMonad configuration files using a C preprocessor-based macro system to enhance the KMonad config format. Layer data is generated by Miryoku Babel and included from files in `src/miryoku_babel/`.

@//Users/jacob/repos/miryoku_babel/miryoku_babel/CLAUDE.md

## Build System

### Building Config Files

The build process uses `cpp` (C preprocessor) and `sed` to convert `.kbd.cpp` source files into `.kbd` KMonad config files.

**Build commands:**
```sh
cd src
make                    # Build with defaults
make test              # Build and dry-run with kmonad -d
```

**Build with options:**
```sh
make MIRYOKU_ALPHAS=QWERTY MIRYOKU_MAPPING=LITE MIRYOKU_KMONAD_OS=MAC
```

**Output:** Generated config files are placed in `src/build/miryoku_kmonad.kbd`

### Available Build Options

- `MIRYOKU_ALPHAS` - Alternative layouts (QWERTY, COLEMAKDH, etc.)
- `MIRYOKU_EXTRA` - Extra layer layout
- `MIRYOKU_TAP` - Tap layer layout
- `MIRYOKU_NAV` - Navigation layer variant (INVERTEDT, etc.)
- `MIRYOKU_CLIPBOARD` - Clipboard shortcuts (WIN, MAC, FUN)
- `MIRYOKU_LAYERS` - Layer arrangement (FLIP)
- `MIRYOKU_MAPPING` - Keyboard mapping (LITE, NOREVERSEANGLE, TAP, KINESIS_ADVANTAGE)
- `MIRYOKU_KMONAD_OS` - Operating system (MAC, WIN, or default Linux)

### Preprocessor Substitutions

The build system uses sed to substitute special tokens that `cpp` cannot preserve:

- `U_QUOT` → `'`
- `U_DQUO` → `"`
- `U_COMM` → `,`
- `U_LPRN` → `\(`
- `U_RPRN` → `\)`
- `U_PIPE` → `|`
- `U_LF` → newline
- `U_TAB` → tab

## Architecture

### Source Files

- `src/miryoku_kmonad.kbd.cpp` - Main config template using C preprocessor directives
- `src/miryoku.h` - Macro definitions for layer mappings, mod-taps, layer-taps, and clipboard shortcuts
- `src/miryoku_babel/` - Auto-generated layer data from Miryoku Babel
  - `miryoku_layer_selection.h` - Layer selection logic
  - `miryoku_layer_list.h` - Layer definitions
  - `miryoku_layer_alternatives.h` - Alternative layouts
- `src/custom_config.h` - User customizations (appended to by workflows)
- `src/custom_rules.mk` - User build rules (appended to by workflows)
- `src/post_rules.mk` - Post-processing rules

### Key Macros

- `U_MT(TAP, HOLD)` - Mod-tap with 150ms hold timeout
- `U_LT(TAP, HOLD)` - Layer-tap with 150ms hold timeout
- `U_DF(LAYER)` - Layer switch on double-tap
- `MIRYOKU_LAYERMAPPING_*` - Layer-specific key mappings

### Keyboard Mappings

The default mapping applies an angled ortho split layout to row-staggered keyboards with:
- Reversed left hand column angle to reduce ulnar deviation
- Rows moved up for better thumb key positioning
- Hands separated maximally

Other mappings include LITE (traditional positions + home row mods), NOREVERSEANGLE, TAP (tap functions only), and KINESIS_ADVANTAGE.

## GitHub Actions Workflows

Located in `.github/workflows/`:

- `main.yml` - Core workflow that processes build matrix and generates artifacts
- `build.yml` - Build workflow (user edits file)
- `build-inputs.yml` - Build via form inputs (no file editing)
- `build-all.yml` - Build all combinations
- `test.yml` - Test workflow that validates generated configs with `kmonad -d`

Workflows use the main.yml workflow with different inputs for mode (build vs test), and support matrix builds across multiple option values.

## Development Workflow

1. Edit `src/miryoku_kmonad.kbd.cpp` or `src/miryoku.h` as needed
2. Build: `cd src && make`
3. Test dry-run: `make test` (requires kmonad installed)
4. For custom options, append to `src/custom_config.h` or `src/custom_rules.mk`

## Customization Hook

The `hooks/copy_miryoku_kmonad.sh` script rebuilds and copies the config to `~/.miryoku_kmonad.kbd`.
